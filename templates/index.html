<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ“ Student Management System</h1>
            <p class="subtitle">Create, Read, Update, and Delete Student Records</p>
        </header>

        <div class="form-container">
            <h2 id="form-title">Add New Student</h2>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-name">Name *</label>
                        <input type="text" id="student-name" placeholder="Enter student name..." required>
                    </div>
                    <div class="form-group">
                        <label for="student-email">Email</label>
                        <input type="email" id="student-email" placeholder="Enter email...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-age">Age</label>
                        <input type="number" id="student-age" placeholder="Enter age..." min="1" max="150">
                    </div>
                    <div class="form-group">
                        <label for="student-course">Course</label>
                        <input type="text" id="student-course" placeholder="Enter course...">
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Student</button>
                    <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;">Cancel</button>
                </div>
            </form>
        </div>

        <div class="table-container">
            <h2>Students List</h2>
            <div id="loading" class="loading" style="display: none;">Loading...</div>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <table id="students-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Age</th>
                        <th>Course</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="students-body">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
            <p id="no-students" class="no-students" style="display: none;">No students found. Add your first student!</p>
        </div>
    </div>

    <script>
        let isEditing = false;
        let editingId = null;

        // Load students when page loads
        document.addEventListener('DOMContentLoaded', loadStudents);

        // Form submission
        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('student-name').value.trim();
            const email = document.getElementById('student-email').value.trim();
            const age = document.getElementById('student-age').value;
            const course = document.getElementById('student-course').value.trim();
            
            if (!name) return;

            const studentData = {
                name: name,
                email: email || null,
                age: age ? parseInt(age) : null,
                course: course || null
            };

            if (isEditing) {
                await updateStudent(editingId, studentData);
            } else {
                await createStudent(studentData);
            }
        });

        // Cancel edit
        document.getElementById('cancel-btn').addEventListener('click', () => {
            resetForm();
        });

        // Load all students
        async function loadStudents() {
            showLoading(true);
            try {
                const response = await fetch('/api/students');
                if (!response.ok) throw new Error('Failed to load students');
                
                const students = await response.json();
                displayStudents(students);
            } catch (error) {
                showError('Error loading students: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Display students in table
        function displayStudents(students) {
            const tbody = document.getElementById('students-body');
            const noStudents = document.getElementById('no-students');
            
            if (students.length === 0) {
                tbody.innerHTML = '';
                noStudents.style.display = 'block';
                return;
            }

            noStudents.style.display = 'none';
            tbody.innerHTML = students.map(student => `
                <tr data-id="${student.id}">
                    <td>${student.id}</td>
                    <td>${escapeHtml(student.name)}</td>
                    <td>${escapeHtml(student.email)}</td>
                    <td>${student.age || '-'}</td>
                    <td>${escapeHtml(student.course)}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Create new student
        async function createStudent(studentData) {
            try {
                const response = await fetch('/api/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create student');
                }

                resetForm();
                await loadStudents();
                showSuccess('Student created successfully!');
            } catch (error) {
                showError('Error creating student: ' + error.message);
            }
        }

        // Edit student
        async function editStudent(id) {
            try {
                const response = await fetch(`/api/students/${id}`);
                if (!response.ok) throw new Error('Failed to fetch student');
                
                const student = await response.json();
                
                isEditing = true;
                editingId = id;
                
                document.getElementById('form-title').textContent = 'Edit Student';
                document.getElementById('student-id').value = student.id;
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-email').value = student.email || '';
                document.getElementById('student-age').value = student.age || '';
                document.getElementById('student-course').value = student.course || '';
                document.getElementById('submit-btn').textContent = 'Update Student';
                document.getElementById('cancel-btn').style.display = 'inline-block';
                
                document.getElementById('student-name').focus();
            } catch (error) {
                showError('Error fetching student: ' + error.message);
            }
        }

        // Update student
        async function updateStudent(id, studentData) {
            try {
                const response = await fetch(`/api/students/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update student');
                }

                resetForm();
                await loadStudents();
                showSuccess('Student updated successfully!');
            } catch (error) {
                showError('Error updating student: ' + error.message);
            }
        }

        // Delete student
        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                const response = await fetch(`/api/students/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete student');
                }

                await loadStudents();
                showSuccess('Student deleted successfully!');
            } catch (error) {
                showError('Error deleting student: ' + error.message);
            }
        }

        // Reset form
        function resetForm() {
            isEditing = false;
            editingId = null;
            
            document.getElementById('form-title').textContent = 'Add New Student';
            document.getElementById('student-id').value = '';
            document.getElementById('student-name').value = '';
            document.getElementById('student-email').value = '';
            document.getElementById('student-age').value = '';
            document.getElementById('student-course').value = '';
            document.getElementById('submit-btn').textContent = 'Add Student';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // Helper functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.className = 'success-message';
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.className = 'error-message';
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#x27;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Create Invoice - TailorShop{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'invoice_list' %}">Invoices</a></li>
                <li class="breadcrumb-item active">Create Invoice</li>
            </ol>
        </nav>
        <h1><i class="bi bi-file-earmark-plus me-2"></i>Create Invoice</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Order <span class="text-danger">*</span></label>
                        <select name="order" class="form-select" required id="orderSelect">
                            <option value="">Select an order...</option>
                            {% for order in orders %}
                            <option value="{{ order.pk }}" 
                                    data-customer="{{ order.customer.name }}"
                                    data-items="{{ order.items.count }}"
                                    data-total="{{ order.total_amount }}">
                                {{ order.order_number }} - {{ order.customer.name }} (₹{{ order.total_amount }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Order Details Preview -->
                    <div id="orderPreview" class="d-none">
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="bi bi-info-circle me-1"></i>Order Summary</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Customer:</strong> <span id="previewCustomer"></span><br>
                                    <strong>Items:</strong> <span id="previewItems"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Total Amount:</strong> ₹<span id="previewTotal"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Discount Type</label>
                                <select name="discount_type" class="form-select" id="discountType">
                                    <option value="NONE">No Discount</option>
                                    <option value="PERCENTAGE">Percentage (%)</option>
                                    <option value="FIXED">Fixed Amount (₹)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="discountValueDiv" style="display: none;">
                                <label class="form-label">Discount Value</label>
                                <input type="number" name="discount_value" class="form-control" 
                                       id="discountValue" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" 
                                  placeholder="Any special notes for the invoice..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Create Invoice
                        </button>
                        <a href="{% url 'invoice_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>Tips
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li class="mb-2">Select an order that doesn't have an invoice yet.</li>
                    <li class="mb-2">You can apply discounts either as percentage or fixed amount.</li>
                    <li class="mb-2">After creating, you can add payments against this invoice.</li>
                    <li>Use Quick Billing for faster order and invoice creation.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderSelect = document.getElementById('orderSelect');
    const orderPreview = document.getElementById('orderPreview');
    const discountType = document.getElementById('discountType');
    const discountValueDiv = document.getElementById('discountValueDiv');
    
    orderSelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (this.value) {
            document.getElementById('previewCustomer').textContent = selected.dataset.customer;
            document.getElementById('previewItems').textContent = selected.dataset.items;
            document.getElementById('previewTotal').textContent = selected.dataset.total;
            orderPreview.classList.remove('d-none');
        } else {
            orderPreview.classList.add('d-none');
        }
    });
    
    discountType.addEventListener('change', function() {
        if (this.value === 'NONE') {
            discountValueDiv.style.display = 'none';
        } else {
            discountValueDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}

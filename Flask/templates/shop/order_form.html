{% extends 'base.html' %}

{% block title %}{{ title }} - TailorShop{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'order_list' %}">Orders</a></li>
                <li class="breadcrumb-item active">{{ title }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-bag-plus me-2"></i>{{ title }}</h1>
    </div>
</div>

<form method="post" id="orderForm">
    {% csrf_token %}
    
    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Customer Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-person me-2"></i>Customer Details
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Customer <span class="text-danger">*</span></label>
                            {{ form.customer }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Measurement Profile</label>
                            {{ form.profile }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'customer_add' %}?next=order" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus me-1"></i>Add New Customer
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check me-2"></i>Order Items</span>
                </div>
                <div class="card-body">
                    <div id="orderItems">
                        {% if items %}
                        {% for item in items %}
                        <div class="item-row" data-index="{{ forloop.counter0 }}">
                            <select name="garment_type" class="form-select garment-select" required>
                                <option value="">Select Garment</option>
                                {% for gt in garment_types %}
                                <option value="{{ gt.pk }}" data-price="{{ gt.base_price }}" {% if item.garment_type_id == gt.pk %}selected{% endif %}>
                                    {{ gt.name }} - ₹{{ gt.base_price }}
                                </option>
                                {% endfor %}
                            </select>
                            <select name="stitching_type" class="form-select stitching-select" required>
                                <option value="">Stitching Type</option>
                                {% for st in stitching_types %}
                                <option value="{{ st.pk }}" data-multiplier="{{ st.price_multiplier }}" data-extra="{{ st.extra_charge }}" {% if item.stitching_type_id == st.pk %}selected{% endif %}>
                                    {{ st.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" name="quantity" class="form-control quantity-input" value="{{ item.quantity }}" min="1" placeholder="Qty">
                            <input type="number" name="price" class="form-control price-input" value="{{ item.price }}" step="0.01" placeholder="Price" required>
                            <button type="button" class="btn btn-outline-danger btn-icon remove-item">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="item-row" data-index="0">
                            <select name="garment_type" class="form-select garment-select" required>
                                <option value="">Select Garment</option>
                                {% for gt in garment_types %}
                                <option value="{{ gt.pk }}" data-price="{{ gt.base_price }}">{{ gt.name }} - ₹{{ gt.base_price }}</option>
                                {% endfor %}
                            </select>
                            <select name="stitching_type" class="form-select stitching-select" required>
                                <option value="">Stitching Type</option>
                                {% for st in stitching_types %}
                                <option value="{{ st.pk }}" data-multiplier="{{ st.price_multiplier }}" data-extra="{{ st.extra_charge }}">{{ st.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="number" name="quantity" class="form-control quantity-input" value="1" min="1" placeholder="Qty">
                            <input type="number" name="price" class="form-control price-input" step="0.01" placeholder="Price" required>
                            <button type="button" class="btn btn-outline-danger btn-icon remove-item">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="add-item-btn mt-3" id="addItemBtn">
                        <i class="bi bi-plus-lg me-2"></i>Add Another Item
                    </button>
                    
                    <!-- Notes -->
                    <div id="itemNotes" class="mt-3" style="display: none;">
                        <label class="form-label">Item Notes (comma separated)</label>
                        <input type="text" name="item_notes" class="form-control" placeholder="Notes for each item">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Settings -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-gear me-2"></i>Order Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Delivery Date</label>
                        {{ form.delivery_date }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        {{ form.priority }}
                    </div>
                    <div class="mb-0">
                        <label class="form-label">Notes</label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-calculator me-2"></i>Order Summary
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Items:</span>
                        <span id="itemCount">1</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="subtotal">₹0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong class="text-primary" id="total">₹0.00</strong>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-check-lg me-2"></i>Save Order
                    </button>
                    <a href="{% url 'order_list' %}" class="btn btn-outline-secondary w-100">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Item Template -->
<template id="itemTemplate">
    <div class="item-row">
        <select name="garment_type" class="form-select garment-select" required>
            <option value="">Select Garment</option>
            {% for gt in garment_types %}
            <option value="{{ gt.pk }}" data-price="{{ gt.base_price }}">{{ gt.name }} - ₹{{ gt.base_price }}</option>
            {% endfor %}
        </select>
        <select name="stitching_type" class="form-select stitching-select" required>
            <option value="">Stitching Type</option>
            {% for st in stitching_types %}
            <option value="{{ st.pk }}" data-multiplier="{{ st.price_multiplier }}" data-extra="{{ st.extra_charge }}">{{ st.name }}</option>
            {% endfor %}
        </select>
        <input type="number" name="quantity" class="form-control quantity-input" value="1" min="1" placeholder="Qty">
        <input type="number" name="price" class="form-control price-input" step="0.01" placeholder="Price" required>
        <button type="button" class="btn btn-outline-danger btn-icon remove-item">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderItems = document.getElementById('orderItems');
    const addItemBtn = document.getElementById('addItemBtn');
    const itemTemplate = document.getElementById('itemTemplate');
    
    // Add new item
    addItemBtn.addEventListener('click', function() {
        const clone = itemTemplate.content.cloneNode(true);
        orderItems.appendChild(clone);
        updateSummary();
        attachItemListeners();
    });
    
    // Calculate price automatically
    function calculatePrice(row) {
        const garmentSelect = row.querySelector('.garment-select');
        const stitchingSelect = row.querySelector('.stitching-select');
        const priceInput = row.querySelector('.price-input');
        
        const garmentOption = garmentSelect.options[garmentSelect.selectedIndex];
        const stitchingOption = stitchingSelect.options[stitchingSelect.selectedIndex];
        
        if (garmentOption && stitchingOption) {
            const basePrice = parseFloat(garmentOption.dataset.price) || 0;
            const multiplier = parseFloat(stitchingOption.dataset.multiplier) || 1;
            const extra = parseFloat(stitchingOption.dataset.extra) || 0;
            
            const calculatedPrice = (basePrice * multiplier) + extra;
            priceInput.value = calculatedPrice.toFixed(2);
        }
        
        updateSummary();
    }
    
    // Update order summary
    function updateSummary() {
        const rows = orderItems.querySelectorAll('.item-row');
        let total = 0;
        
        rows.forEach(row => {
            const qty = parseInt(row.querySelector('.quantity-input').value) || 1;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            total += qty * price;
        });
        
        document.getElementById('itemCount').textContent = rows.length;
        document.getElementById('subtotal').textContent = '₹' + total.toFixed(2);
        document.getElementById('total').textContent = '₹' + total.toFixed(2);
    }
    
    // Attach listeners to item rows
    function attachItemListeners() {
        orderItems.querySelectorAll('.item-row').forEach(row => {
            row.querySelector('.garment-select').addEventListener('change', () => calculatePrice(row));
            row.querySelector('.stitching-select').addEventListener('change', () => calculatePrice(row));
            row.querySelector('.quantity-input').addEventListener('input', updateSummary);
            row.querySelector('.price-input').addEventListener('input', updateSummary);
            
            row.querySelector('.remove-item').addEventListener('click', function() {
                if (orderItems.querySelectorAll('.item-row').length > 1) {
                    row.remove();
                    updateSummary();
                }
            });
        });
    }
    
    // Load measurement profiles when customer changes
    document.getElementById('customer-select')?.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
            fetch(`/api/customer/${customerId}/`)
                .then(response => response.json())
                .then(data => {
                    const profileSelect = document.querySelector('[name="profile"]');
                    profileSelect.innerHTML = '<option value="">Select Profile</option>';
                    data.profiles.forEach(profile => {
                        profileSelect.innerHTML += `<option value="${profile.id}">${profile.name}</option>`;
                    });
                });
        }
    });
    
    // Initialize
    attachItemListeners();
    updateSummary();
});
</script>
{% endblock %}
